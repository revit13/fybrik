global:
  enabled: true
  tlsDisable: false
server:
  extraEnvironmentVars:
    VAULT_CACERT: /vault/userconfig/vault-server-tls/ca.crt
  logLevel: debug
  logFormat: standard
  debug: true
  readinessProbe:
    enabled: false 
    # If you need to use a http path instead of the default exec
    # path: /v1/sys/health?standbyok=true

    # When a probe fails, Kubernetes will try failureThreshold times before giving up
    failureThreshold: 2
    # Number of seconds after the container has started before probe initiates
    initialDelaySeconds: 20
  # authDelegator enables a cluster role binding to be attached to the service
  # account.  This cluster role binding can be used to setup Kubernetes auth
  # method.  https://www.vaultproject.io/docs/auth/kubernetes.html
  authDelegator:
    enabled: true
  volumes: 
    - name: data
      emptyDir: {}
    - name: kubectl
      emptyDir: {}
    - name: plugins
      emptyDir: {}
  extraVolumes:
    - type: secret
      name: vault-server-tls # Matches the ${SECRET_NAME} from above
  volumeMounts:
    - mountPath: /vault/data/
      name: data
      readOnly: false
    - name: kubectl
      subPath: kubectl
      mountPath: /usr/local/bin/kubectl
    - mountPath: /usr/local/libexec/vault
      name: plugins
      readOnly: false
  extraInitContainers:
    - name: install-kubectl
      image: allanlei/kubectl
      command: [/bin/sh, -ec]
      args:
      - cp /usr/local/bin/kubectl /data/kubectl
      volumeMounts:
      - name: kubectl
        mountPath: /data
        readOnly: false
    - name: wkcsecrets-plugin
      image: ghcr.io/the-mesh-for-data/vault-plugin-secrets-wkc-reader:latest
      imagePullPolicy: Always
      command: [/bin/sh, -ec]
      args:
        - cp /vault-plugin-secrets-wkc-reader /usr/local/libexec/vault/vault-plugin-secrets-wkc-reader
      volumeMounts:
      - name: plugins
        mountPath: /usr/local/libexec/vault
        readOnly: false
    - name: kubesecrets-plugin
      image: ghcr.io/the-mesh-for-data/vault-plugin-secrets-kubernetes-reader:latest
      command: [/bin/sh, -ec]
      args:
        - cp /vault-plugin-secrets-kubernetes-reader /usr/local/libexec/vault/vault-plugin-secrets-kubernetes-reader
      volumeMounts:
      - name: plugins
        mountPath: /usr/local/libexec/vault
        readOnly: false
  standalone:
    enabled: true
    config: |
      ui = true
      listener "tcp" {
        address = "[::]:8200"
        cluster_address = "[::]:8201"
        tls_cert_file = "/vault/userconfig/vault-server-tls/tls.crt"
        tls_key_file  = "/vault/userconfig/vault-server-tls/tls.key"
      }
      storage "file" {
        path = "/vault/data"
      }
      plugin_directory = "/usr/local/libexec/vault/"
  postStart:
    - "sh"
    - "-c"
    # Sleep command is needed to avoid synchronization issues with the container pod. Please see
    # https://kubernetes.io/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/#discussion
    # FIXME: Use a proper way to configure Vault after Vault start-up
    - |
      sleep 5
      # vault operator init commands works only if no data exists
      rm -rf /vault/data/*
      vault operator init | tee /tmp/vault.init > /dev/null
      cat /tmp/vault.init | grep '^Unseal' | awk '{print $4}' | for key in $(cat -); do
        vault operator unseal $key
      done
      export ROOT_TOKEN=$(cat /tmp/vault.init | grep '^Initial' | awk '{print $4}')
      echo "Remove master keys from disk"
      #  shred /tmp/vault.init
      vault login $ROOT_TOKEN
      # configuring kubernetes auth method and use it later to create roles.
      vault auth enable kubernetes
      vault write auth/kubernetes/config kubernetes_host="https://kubernetes.default.svc:443"
      # enable secret engine
      SHA256=$(sha256sum /usr/local/libexec/vault/vault-plugin-secrets-kubernetes-reader | cut -d ' ' -f1)
      vault plugin register -sha256=$SHA256 secret vault-plugin-secrets-kubernetes-reader
      SHA256=$(sha256sum /usr/local/libexec/vault/vault-plugin-secrets-wkc-reader | cut -d ' ' -f1)
      vault plugin register -sha256=$SHA256 secret vault-plugin-secrets-wkc-reader
      vault secrets enable -path=kubernetes-secrets vault-plugin-secrets-kubernetes-reader
      vault secrets enable -path=wkc-creds vault-plugin-secrets-wkc-reader
      # create policy to access secrets
      # NOTE: m4d/dataset-creds/ secret engine is enabled by the manager and is used temporarily
      # to store dataset credentials.
      vault policy write "allow-all-dataset-creds" - <<EOF
      path "kubernetes-secrets/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
      }
      path "wkc-creds/*" {
      capabilities = ["create", "read", "update", "delete", "list"]
      }
      EOF
      # allow modules running in m4d-blueprints namespace to access dataset credentials
      vault write auth/kubernetes/role/module bound_service_account_names="*" bound_service_account_namespaces="m4d-blueprints" policies="allow-all-dataset-creds" ttl=24h
      # allow manager to access dataset credentials
      vault write auth/kubernetes/role/manager bound_service_account_names="m4d-manager" bound_service_account_namespaces="m4d-system" policies="allow-all-dataset-creds" ttl=24h
      # enable userpass auth method
      vault auth enable userpass
      vault write auth/userpass/users/data_provider password=password policies="allow-all-dataset-creds"


