global:
  enabled: true
  tlsDisable: false
server:
  extraEnvironmentVars:
    VAULT_CACERT: /vault/userconfig/vault-server-tls/ca.crt
  logLevel: debug
  logFormat: standard
  debug: true
  readinessProbe:
    enabled: false 
    # If you need to use a http path instead of the default exec
    # path: /v1/sys/health?standbyok=true

    # When a probe fails, Kubernetes will try failureThreshold times before giving up
    failureThreshold: 2
    # Number of seconds after the container has started before probe initiates
    initialDelaySeconds: 20
  # authDelegator enables a cluster role binding to be attached to the service
  # account.  This cluster role binding can be used to setup Kubernetes auth
  # method.  https://www.vaultproject.io/docs/auth/kubernetes.html
  authDelegator:
    enabled: true
  volumes: 
    - name: data
      emptyDir: {}
    - name: kubectl
      emptyDir: {}
  extraVolumes:
    - type: secret
      name: vault-server-tls # Matches the ${SECRET_NAME} from above
  volumeMounts:
    - mountPath: /vault/data/
      name: data
      readOnly: false
    - name: kubectl
      subPath: kubectl
      mountPath: /usr/local/bin/kubectl
  initContainers:
  - name: install-kubectl
    image: allanlei/kubectl
    volumeMounts:
    - name: kubectl
      mountPath: /data
      command: ["cp", "/usr/local/bin/kubectl", "/data/kubectl"]
  standalone:
    enabled: true
    config: |
      ui = true
      listener "tcp" {
        address = "[::]:8200"
        cluster_address = "[::]:8201"
        tls_cert_file = "/vault/userconfig/vault-server-tls/tls.crt"
        tls_key_file  = "/vault/userconfig/vault-server-tls/tls.key"
      }
      storage "file" {
        path = "/vault/data"
      }
  postStart:
    - "sh"
    - "-c"
    # Sleep command is needed to avoid synchronization issues with the container pod. Please see
    # https://kubernetes.io/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/#discussion
    # FIXME: Use a proper way to configure Vault after Vault start-up
    - |
      sleep 5
      vault operator init | tee /tmp/vault.init > /dev/null
      cat /tmp/vault.init | grep '^Unseal' | awk '{print $4}' | for key in $(cat -); do
        vault operator unseal $key
      done
      cat /tmp/vault.init | grep 'Initial Root Token'  | awk '{print $2}'  
      echo "Remove master keys from disk"
      shred /tmp/vault.init

